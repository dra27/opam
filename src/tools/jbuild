(* -*- tuareg -*- *)

#use "../jbuild.common"

let build_putenv =
  if cc64 = "" then "" else {|
(install
  ((section bin)
   (package opam)
   (files (opam-putenv.exe))))
|}

let () = out {|
(jbuild_version 1)

(executable
  ((name opam_admin_topstart)
   (modules (opam_admin_top opam_admin_topstart))
   (ocamlc_flags (:standard %s -linkall))
   (libraries (opam-client opam-file-format compiler-libs.toplevel re.glob))))

(install
  ((section bin)
   (package opam-admin)
   (files ((opam_admin_topstart.bc as opam-admin.top)))))

(executable
  ((name opam_check)
   (modules (opam_check))
   (flags (:standard %s))
   (libraries (opam-client))))

(rule
  ((targets (opam-putenv.exe))
   (deps    (opam-putenv.c ../core/opamInject.c))
   (action  (run %s %s ${<}))))
%s
(executable
  ((name opam_installer)
   (package opam)
   (public_name opam-installer)
   (modules (opam_installer))
   (libraries (opam-state cmdliner))
   (flags (:standard %s))))
|} ocaml_flags ocaml_flags cc64 c_flags build_putenv ocaml_flags
